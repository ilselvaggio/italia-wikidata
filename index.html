<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikidata Italia Overview</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        
        /* HEADER STYLE */
        #header {
            background-color: #333;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            position: relative;
            height: 50px;
            box-sizing: border-box;
        }
        
        #left-col { display: flex; align-items: center; gap: 15px; }
        #title { font-weight: 700; font-size: 18px; white-space: nowrap; }

        #regionSelect {
            background: #555; border: none; color: white; padding: 5px 10px; border-radius: 4px; font-size: 14px; cursor: pointer; max-width: 150px;
        }

        #controls { display: flex; gap: 15px; align-items: center; font-size: 13px; }

        .stat-item { display: flex; align-items: center; gap: 5px; cursor: pointer; white-space: nowrap; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; border: 1px solid #fff; flex-shrink: 0; }
        .dot-red { background: #e74c3c; }
        .dot-green { background: #2ecc71; }
        
        #meta-info { font-size: 11px; color: #aaa; margin-left: 5px; border-left: 1px solid #555; padding-left: 10px; white-space: nowrap; }

        /* HANDY-ANSICHT (Responsive) */
        @media (max-width: 600px) {
            #header {
                height: auto; 
                flex-direction: column; 
                align-items: stretch;
                padding: 10px;
                gap: 8px;
            }
            #left-col { justify-content: space-between; width: 100%; }
            #controls {
                justify-content: space-between;
                flex-wrap: wrap;
                background: rgba(255,255,255,0.05);
                padding: 8px;
                border-radius: 4px;
                width: 100%;
                box-sizing: border-box;
            }
            #regionSelect { max-width: 60%; }
            
            /* Datum auf Handy sichtbar und ordentlich platziert */
            #meta-info { 
                display: block; 
                border-left: none; 
                padding-left: 0; 
                margin-left: 0; 
                margin-top: 5px; 
                width: 100%; 
                text-align: right; 
                font-size: 10px;
                color: #ccc;
            }
            
            #map { height: calc(100% - 110px) !important; } 
        }

        #map { height: calc(100% - 50px); width: 100%; background: #f0f0f0; }

        /* POPUP STYLE */
        .leaflet-popup-content-wrapper { border-radius: 6px; }
        .popup-content { font-size: 14px; min-width: 180px; }
        .popup-header { font-weight: bold; margin-bottom: 5px; font-size: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .popup-meta { color: #666; margin-bottom: 10px; font-family: monospace; font-size: 12px; }
        .btn { display: block; text-align: center; padding: 6px; margin-top: 5px; text-decoration: none; border-radius: 4px; color: white; font-weight: 500; font-size: 13px; }
        .btn-wiki { background-color: #333; }
        .btn-osm { background-color: #2ecc71; }

    </style>
</head>
<body>

<header id="header">
    <div id="left-col">
        <div id="title">Wikidata Italia</div>
        <select id="regionSelect" onchange="changeRegion(this.value)">
            <option value="" disabled selected>Caricamento...</option>
        </select>
    </div>

    <div id="controls">
        <div id="loading" style="display:none; color: #f1c40f;">Caricamento...</div>
        
        <div class="stat-item" id="stat-missing" style="display:none" onclick="toggleCheckbox('chkMissing')">
            <span class="dot dot-red"></span>
            <input type="checkbox" id="chkMissing" checked onchange="toggleLayer('missing', this.checked)">
            Missing <span id="count-missing"></span>
        </div>
        
        <div class="stat-item" id="stat-done" style="display:none" onclick="toggleCheckbox('chkDone')">
            <span class="dot dot-green"></span>
            <input type="checkbox" id="chkDone" onchange="toggleLayer('done', this.checked)">
            Mapped <span id="count-done"></span>
        </div>
        
        <div id="meta-info">Aggiornato: <span id="last-updated">-</span></div>
    </div>
</header>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    var map = L.map('map', { preferCanvas: true, zoomControl: false }).setView([42.0, 12.5], 6);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    var layers = { missing: L.layerGroup(), done: L.layerGroup() };
    
    // 1. Laden der Konfiguration und Metadaten
    Promise.all([
        fetch('regions.json').then(r => r.json()),
        fetch('metadata.json').then(r => r.json()).catch(() => ({}))
    ]).then(([regions, metadata]) => {
        // Datum setzen
        if(metadata.last_updated) {
            document.getElementById('last-updated').innerText = metadata.last_updated;
        }

        // Menü befüllen
        var select = document.getElementById('regionSelect');
        select.innerHTML = "";
        
        var sortedKeys = Object.keys(regions).sort((a,b) => regions[a].name.localeCompare(regions[b].name));
        
        sortedKeys.forEach(key => {
            var opt = document.createElement('option');
            opt.value = key;
            opt.innerText = regions[key].name;
            select.appendChild(opt);
        });

        // Erste Region automatisch laden
        if (sortedKeys.length > 0) {
            select.value = sortedKeys[0];
            changeRegion(sortedKeys[0]);
        }
    });

    function changeRegion(key) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('stat-missing').style.display = 'none';
        document.getElementById('stat-done').style.display = 'none';
        
        layers.missing.clearLayers();
        layers.done.clearLayers();

        // 2. Laden der GeoJSON Datei
        fetch(`data_${key}.geojson`)
            .then(res => {
                if (!res.ok) throw new Error("Dati mancanti");
                return res.json();
            })
            .then(data => {
                var countMissing = 0;
                var countDone = 0;
                var bounds = L.latLngBounds([]);

                data.features.forEach(feature => {
                    var p = feature.properties;
                    var latlng = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
                    bounds.extend(latlng);

                    var popupHtml = `<div class="popup-content">
                        <div class="popup-header">${p.name}</div>
                        <div class="popup-meta">${p.wikidata}</div>
                        <a href="https://www.wikidata.org/wiki/${p.wikidata}" target="_blank" class="btn btn-wiki">Wikidata</a>`;
                    if (p.status === 'done' && p.osm_id) {
                        popupHtml += `<a href="https://www.openstreetmap.org/${p.osm_id}" target="_blank" class="btn btn-osm">OpenStreetMap</a>`;
                    }
                    popupHtml += `</div>`;

                    var color = (p.status === 'missing') ? "#e74c3c" : "#2ecc71";
                    var marker = L.circleMarker(latlng, { radius: 5, fillColor: color, color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8 }).bindPopup(popupHtml);

                    if (p.status === 'missing') {
                        layers.missing.addLayer(marker);
                        countMissing++;
                    } else {
                        layers.done.addLayer(marker);
                        countDone++;
                    }
                });

                document.getElementById('count-missing').innerText = `(${countMissing})`;
                document.getElementById('count-done').innerText = `(${countDone})`;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('stat-missing').style.display = 'flex';
                document.getElementById('stat-done').style.display = 'flex';

                if(document.getElementById('chkMissing').checked) map.addLayer(layers.missing);
                if(document.getElementById('chkDone').checked) map.addLayer(layers.done);

                if (bounds.isValid()) map.fitBounds(bounds, {padding: [20, 20]});
            })
            .catch(err => {
                document.getElementById('loading').innerText = "Dati non trovati (Upload?)";
                // Fehler bleibt stehen als Hinweis
            });
    }

    function toggleLayer(type, checked) {
        if (checked) map.addLayer(layers[type]);
        else map.removeLayer(layers[type]);
    }
    
    window.toggleCheckbox = function(id) {
        var chk = document.getElementById(id);
        if (event.target !== chk) {
            chk.checked = !chk.checked;
            chk.dispatchEvent(new Event('change'));
        }
    };
</script>
</body>
</html>
